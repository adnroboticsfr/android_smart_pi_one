name: Android Build for SmartPI ONE

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up JDK
      uses: actions/setup-java@v2
      with:
        java-version: '8'
        distribution: 'adopt'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y openjdk-8-jdk git-core gnupg flex bison gperf build-essential \
        zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 \
        lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev \
        libgl1-mesa-dev libxml2-utils xsltproc unzip bc python3

    - name: Clean up space
      run: |
        sudo rm -rf /home/runner/work/_temp/*
        sudo rm -rf /home/runner/work/_diag/*
        sudo rm -rf ~/android-source/.repo/projects/external/grpc-grpc-java.git/refs/tags/*

    - name: Cache AOSP source
      uses: actions/cache@v2
      with:
        path: ~/android-source
        key: ${{ runner.os }}-aosp-${{ hashFiles('path/to/important/file') }}
        restore-keys: |
          ${{ runner.os }}-aosp

    - name: Sync AOSP source (if not cached)
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        mkdir -p ~/android-source
        cd ~/android-source
        export PATH=~/bin:$PATH
        repo init -u https://android.googlesource.com/platform/manifest -b android-11.0.0_r1
        repo sync -j2  # Limite le nombre de threads

    - name: Copy NanoPi M1-specific files
      run: |
        cp $GITHUB_WORKSPACE/device/friendlyarm/smartpi_one/* ~/android-source/device/friendlyarm/smartpi_one/

    - name: Build Android for NanoPi M1
      run: |
        cd ~/android-source
        source build/envsetup.sh
        lunch aosp_smartpi_one-userdebug
        make -j8

    - name: Upload built image
      uses: actions/upload-artifact@v3  # Mise Ã  jour ici
      with:
        name: android-image
        path: out/target/product/smartpi_one/
